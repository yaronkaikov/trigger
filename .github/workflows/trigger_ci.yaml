name: Trigger next gating

on:
  workflow_dispatch:
    inputs:
      base_sha:
        description: 'Base commit SHA'
        required: true
        type: string
      head_sha:
        description: 'Head commit SHA'
        required: true
        type: string
  pull_request_target:
    types: [opened, reopened, synchronize]
    
jobs:
  trigger-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Checkout PR code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed to access full history

      - name: Get base and head SHAs
        run: |
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"

      - name: List changed files between SHAs
        run: |
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}
      # - name: Determine Jenkins Job Name
      #   run: |
      #     if [[ "${{ github.ref_name }}" == "next" ]]; then
      #       FOLDER_NAME="scylla-master"
      #     elif [[ "${{ github.ref_name }}" == "next-enterprise" ]]; then
      #       FOLDER_NAME="scylla-enterprise"
      #     else
      #       VERSION=$(echo "${{ github.ref_name }}" | awk -F'-' '{print $2}')
      #       if [[ "$VERSION" =~ ^202[0-4]\.[0-9]+$ ]]; then
      #         FOLDER_NAME="enterprise-$VERSION"
      #       elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+$ ]]; then
      #         FOLDER_NAME="scylla-$VERSION"
      #       fi
      #     fi
      #     echo "JOB_NAME=${FOLDER_NAME}/job/next" >> $GITHUB_ENV

      # - name: Trigger Jenkins Job
      #   env:
      #     JENKINS_USER: ${{ secrets.JENKINS_USERNAME }}
      #     JENKINS_API_TOKEN: ${{ secrets.JENKINS_TOKEN }}
      #     JENKINS_URL: "https://jenkins.scylladb.com"
      #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      #   run: |
      #     echo "Checking Existence of Jenkins Job: $JOB_NAME"
      #     JOB_URL="$JENKINS_URL/job/$JOB_NAME/api/json"
      #     if ! curl --silent --fail --user "$JENKINS_USER:$JENKINS_API_TOKEN" "$JOB_URL" > /dev/null; then
      #       echo "Jenkins job $JOB_NAME does not exist yet. Skipping trigger."
      #       exit 0
      #     fi

      #     echo "Triggering Jenkins Job: $JOB_NAME"
      #     if ! curl -X POST "$JENKINS_URL/job/$JOB_NAME/buildWithParameters" --fail --user "$JENKINS_USER:$JENKINS_API_TOKEN" -i -v; then
      #       echo "Error: Jenkins job trigger failed"
      #       # Send Slack message
      #       curl -X POST -H 'Content-type: application/json' \
      #         -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
      #         --data '{
      #           "channel": "#releng-team",
      #           "text": "ðŸš¨ Jenkins job *'$JOB_NAME'* failed!",
      #           "icon_emoji": ":warning:"
      #         }' \
      #         https://slack.com/api/chat.postMessage

      #       exit 1
      #     fi
