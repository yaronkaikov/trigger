name: Trigger next gating

on:
  push:
    branches:
      - main

jobs:
  trigger-jenkins:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Start Jenkins Job
        uses: scylladb-actions/jenkins-client@v0.2.0
        with:
          job_name: 'releng-testing/job/ami'
          jenkins_job_parameters: '{"APP_ENV_NAME": "staging"}'
          base_url: https://jenkins.scylladb.com
          user: 'yaronkaikov'
          password: ${{ secrets.JENKINS_TOKEN }}

      - name: Notify Slack on Failure
        if: failure()
        run: |
          echo "Action failed, sending Slack alert..."
          curl -X POST -H 'Content-type: application/json' \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            --data '{
              "channel": "#sandbox-channel",
              "text": "ðŸš¨ @here '${{ env.JOB_NAME }}' failed to be triggered, please check https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }} for more details."
            }' \
            https://slack.com/api/chat.postMessage
